<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Người Cầm Quyền Simulator - With Difficulty Modes</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;700&family=Source+Sans+Pro:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        font-family: "Source Sans Pro", sans-serif;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
        color: #f5f5f5;
        overflow-x: hidden;
      }

      /* Difficulty Selection Screen */
      .difficulty-selection {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.95);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .difficulty-modal {
        background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
        padding: 40px;
        border-radius: 20px;
        max-width: 700px;
        text-align: center;
        border: 2px solid #444;
        box-shadow: 0 20px 40px rgba(0,0,0,0.8);
      }

      .difficulty-option {
        margin: 20px 0;
        padding: 25px;
        border: 2px solid #444;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #333 0%, #222 100%);
      }

      .difficulty-option:hover {
        border-color: #4caf50;
        background: linear-gradient(135deg, #444 0%, #333 100%);
        transform: translateY(-2px);
      }

      .difficulty-option h3 {
        margin: 0 0 10px 0;
        color: #fff;
        font-size: 1.4em;
      }

      .difficulty-option p {
        margin: 0 0 10px 0;
        color: #ccc;
        font-size: 1.1em;
      }

      .difficulty-stats {
        font-size: 0.9em;
        color: #999;
        margin-top: 10px;
      }

      #difficulty-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px 15px;
        border-radius: 20px;
        font-size: 14px;
        z-index: 500;
        border: 1px solid #444;
      }

      /* Start Screen */
      .start-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #000 0%, #333 50%, #000 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        text-align: center;
        transition: opacity 0.8s ease;
      }

      .start-screen.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .start-title {
        font-family: "Merriweather", serif;
        font-size: 3.5em;
        font-weight: 700;
        color: #fff;
        text-align: center;
        margin-bottom: 20px;
        text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
        letter-spacing: 2px;
      }

      .start-subtitle {
        font-size: 1.3em;
        color: #ccc;
        text-align: center;
        margin-bottom: 40px;
        font-style: italic;
      }

      .start-btn {
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        border: none;
        padding: 20px 40px;
        font-size: 1.3em;
        font-weight: 600;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.4s ease;
        text-transform: uppercase;
        letter-spacing: 2px;
        box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
      }

      .start-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 30px rgba(76, 175, 80, 0.4);
      }

      /* Guide Button */
      .guide-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #2d2d2d;
        color: #ffffff;
        border: 2px solid #555;
        padding: 12px 20px;
        font-size: 1em;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 999;
        text-transform: uppercase;
        letter-spacing: 1px;
        display: none;
      }

      .guide-btn:hover {
        background: #1a1a1a;
        border-color: #777;
        color: #fff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
      }

      /* Guide Modal */
      .guide-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.95);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .guide-content {
        background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
        padding: 30px;
        border-radius: 20px;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        border: 2px solid #444;
        box-shadow: 0 20px 40px rgba(0,0,0,0.8);
      }

      .guide-title {
        font-size: 2rem;
        color: #fff;
        text-align: center;
        margin-bottom: 20px;
      }

      .guide-section {
        margin-bottom: 25px;
        padding: 20px;
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
      }

      .guide-section h3 {
        color: #4caf50;
        font-size: 1.3em;
        margin-bottom: 15px;
      }

      .guide-section h4 {
        color: #ffd700;
        font-size: 1.1em;
        margin: 15px 0 10px 0;
      }

      .guide-section p, .guide-section li {
        color: #ccc;
        line-height: 1.6;
        margin-bottom: 8px;
      }

      .guide-section ul {
        margin-left: 20px;
      }

      .ending-item {
        background: rgba(0,0,0,0.3);
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        border-left: 4px solid;
      }

      .ending-success { border-left-color: #4caf50; }
      .ending-failure { border-left-color: #f44336; }
      .ending-special { border-left-color: #ff9800; }

      .close-guide {
        background: #f44336;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        margin-top: 20px;
        float: right;
      }

      .close-guide:hover {
        background: #d32f2f;
      }

      /* Main Container */
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Header */
      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        font-family: "Merriweather", serif;
        font-size: 2.8em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }

      .header .subtitle {
        font-size: 1.2em;
        opacity: 0.9;
        font-style: italic;
      }

      /* Stats Panel */
      .stats-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        backdrop-filter: blur(10px);
      }

      .stat {
        text-align: center;
        padding: 15px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        transition: transform 0.3s ease;
      }

      .stat:hover {
        transform: translateY(-5px);
      }

      .stat-label {
        font-size: 0.9em;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
      }

      .stat-value {
        font-size: 2em;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .stat-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        overflow: hidden;
      }

      .stat-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #81c784);
        border-radius: 4px;
        transition: width 0.5s ease;
      }

      /* Game Info */
      .game-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 15px 25px;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 10px;
      }

      .turn-counter {
        font-size: 1.3em;
        font-weight: 600;
      }

      .game-score {
        font-size: 1.1em;
        opacity: 0.8;
      }

      /* Story Section */
      .story-section {
        background: rgba(255, 255, 255, 0.08);
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 30px;
        border-left: 4px solid #4caf50;
      }

      .story-title {
        font-size: 1.4em;
        font-weight: 600;
        margin-bottom: 15px;
        color: #4caf50;
      }

      .story-text {
        font-size: 1.1em;
        line-height: 1.6;
        margin-bottom: 20px;
      }

      /* Choices */
      .choices-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .choice {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
      }

      .choice:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: #4caf50;
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
      }

      .choice-title {
        font-size: 1.2em;
        font-weight: 600;
        margin-bottom: 10px;
        color: #4caf50;
      }

      .choice-text {
        line-height: 1.5;
        margin-bottom: 15px;
      }

      .choice-effects {
        font-size: 0.9em;
        opacity: 0.8;
        font-style: italic;
      }

      /* Random Event */
      .random-event {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #1a1a1a;
        color: #ffffff;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        animation: slideIn 0.5s ease-out;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.8);
        border: 3px solid #555;
        max-width: 600px;
        width: 90%;
        z-index: 1500;
        display: none;
      }

      .event-title {
        font-size: 1.4em;
        font-weight: 700;
        margin-bottom: 15px;
        color: #ffffff;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      }

      .event-description {
        font-size: 1.1em;
        line-height: 1.5;
        margin-bottom: 20px;
        color: #eeeeee;
      }

      .event-effects {
        background: #333333;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #555;
      }

      .effects-title {
        font-size: 1em;
        font-weight: 600;
        margin-bottom: 10px;
        color: #ffffff;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .effects-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        font-size: 0.9em;
      }

      .effect-item {
        padding: 8px;
        background: #555555;
        border-radius: 6px;
        text-align: center;
        border: 1px solid #777;
      }

      .effect-positive {
        color: #00ff00;
        font-weight: 700;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
      }

      .effect-negative {
        color: #ff4444;
        font-weight: 700;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
      }

      .effect-neutral {
        color: #ffaa00;
        font-weight: 700;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
      }

      @keyframes slideIn {
        from {
          transform: translate(-50%, -60%);
          opacity: 0;
        }
        to {
          transform: translate(-50%, -50%);
          opacity: 1;
        }
      }

      /* Game End */
      .game-end {
        text-align: center;
        padding: 40px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 20px;
        margin-top: 30px;
      }

      .game-end h2 {
        font-size: 2.5em;
        margin-bottom: 20px;
        color: #4caf50;
      }

      .ending-description {
        font-size: 1.3em;
        line-height: 1.6;
        margin-bottom: 30px;
      }

      .restart-btn {
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 1.2em;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .restart-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .start-title {
          font-size: 2.5em;
        }

        .stats-panel {
          grid-template-columns: repeat(2, 1fr);
        }

        .choices-grid {
          grid-template-columns: 1fr;
        }

        .game-info {
          flex-direction: column;
          gap: 10px;
        }

        .difficulty-modal, .guide-content {
          margin: 20px;
          padding: 30px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Start Screen -->
    <div class="start-screen" id="startScreen">
      <h1 class="start-title">NGƯỜI CẦM QUYỀN</h1>
      <p class="start-subtitle">Simulator Chính Trị Chiến Lược</p>
      <button class="start-btn" onclick="showDifficultySelection()">BẮT ĐẦU GAME</button>
    </div>

    <!-- Guide Button -->
    <button class="guide-btn" onclick="openGuide()" id="guideBtn">HƯỚNG DẪN</button>

    <!-- Guide Modal -->
    <div class="guide-modal" id="guideModal">
      <div class="guide-content">
        <h2 class="guide-title">🎮 HƯỚNG DẪN GAME</h2>
        
        <div class="guide-section">
          <h3>📋 Cách Chơi Cơ Bản</h3>
          <p><strong>Mục tiêu:</strong> Duy trì quyền lực và dẫn dắt đất nước thông qua các quyết định chính trị.</p>
          <p><strong>Cơ chế:</strong> Mỗi lượt, bạn sẽ đối mặt với các tình huống và phải chọn 1 trong 2-3 lựa chọn.</p>
          <p><strong>Chỉ số quan trọng:</strong> Quản lý 6 chỉ số - Bất Mãn, Xung Đột, Kinh Tế, Môi Trường, Tự Do, An Ninh.</p>
        </div>

        <div class="guide-section">
          <h3>⚙️ Độ Khó</h3>
          <p><strong>🟢 Easy Mode (15 rounds):</strong> Tác động tiêu cực giảm 30%, tác động tích cực tăng 20%, ít sự kiện ngẫu nhiên</p>
          <p><strong>🟡 Normal Mode (30 rounds):</strong> Cân bằng hoàn hảo, tác động chuẩn, vừa phải sự kiện ngẫu nhiên</p>
          <p><strong>🔴 Hard Mode (50 rounds):</strong> Tác động tiêu cực tăng 40%, tác động tích cực giảm 20%, nhiều sự kiện ngẫu nhiên</p>
        </div>

        <div class="guide-section">
          <h3>🎯 Các Kết Thúc Có Thể Gặp</h3>
          
          <div class="ending-item ending-success">
            <h4>🏆 NHÀ LÃNH ĐẠO TÀI BA - BEST LEADER EVER</h4>
            <p><strong>Điều kiện:</strong> Bất Mãn ≤20, Xung Đột ≤25, Kinh Tế ≥70, Môi Trường ≥60, Tự Do ≥65, An Ninh ≥60</p>
            <p>Kết thúc hoàn hảo nhất! Bạn cân bằng xuất sắc tất cả các yếu tố xã hội.</p>
          </div>

          <div class="ending-item ending-special">
            <h4>⚔️ ĐỘC TÀI QUÂN SỰ (TẠM THỜI)</h4>
            <p><strong>Điều kiện:</strong> An Ninh ≥75, Tự Do ≤25</p>
            <p>Dẫn đến ending Hitler Collapse sau 2 giây. Quyền lực tuyệt đối không bền vững.</p>
          </div>

          <div class="ending-item ending-failure">
            <h4>💥 HẬU QUẢ CỦA ĐỘC TÀI - DICTATOR'S COLLAPSE</h4>
            <p><strong>Điều kiện:</strong> Sau khi trở thành độc tài</p>
            <p>"You look like Hitler after this you will collapse!" - Cách mạng lật đổ chế độ độc tài.</p>
          </div>

          <div class="ending-item ending-failure">
            <h4>🔥 CÁCH MẠNG BÙNG NỔ</h4>
            <p><strong>Điều kiện:</strong> Xung Đột ≥85</p>
            <p>Người dân nổi dậy và lật đổ chính quyền khi xung đột xã hội quá cao.</p>
          </div>

          <div class="ending-item ending-failure">
            <h4>🔻 MẤT QUYỀN LỰC</h4>
            <p><strong>Điều kiện:</strong> Bất Mãn ≥80</p>
            <p>Dân chúng bất mãn tới mức truất phế bạn khỏi chức vụ.</p>
          </div>

          <div class="ending-item ending-failure">
            <h4>📉 SỤP ĐỔ KINH TẾ</h4>
            <p><strong>Điều kiện:</strong> Kinh Tế ≤10</p>
            <p>Nền kinh tế sụp đổ hoàn toàn, đất nước rơi vào khủng hoảng.</p>
          </div>

          <div class="ending-item ending-failure">
            <h4>🌍 THẢM HỌA MÔI TRƯỜNG</h4>
            <p><strong>Điều kiện:</strong> Môi Trường ≤10</p>
            <p>Biến đổi khí hậu và ô nhiễm làm đất nước không thể sinh sống.</p>
          </div>

          <div class="ending-item ending-success">
            <h4>💰 HOÀNG ĐẾ KINH TẾ</h4>
            <p><strong>Điều kiện:</strong> Kinh Tế ≥85 (sau turn 10)</p>
            <p>Phát triển nền kinh tế mạnh mẽ, biến đất nước thành cường quốc.</p>
          </div>

          <div class="ending-item ending-success">
            <h4>🌱 VUA BẢO VỆ MÔI TRƯỜNG</h4>
            <p><strong>Điều kiện:</strong> Môi Trường ≥85 (sau turn 10)</p>
            <p>Biến đất nước thành thiên đường xanh với môi trường hoàn hảo.</p>
          </div>

          <div class="ending-item ending-special">
            <h4>⏰ KẾT THÚC NHIỆM KỲ</h4>
            <p><strong>Điều kiện:</strong> Hoàn thành hết số rounds</p>
            <p>Kết thúc tự nhiên, đánh giá dựa trên các chỉ số cuối game.</p>
          </div>
        </div>

        <div class="guide-section">
          <h3>💡 Chiến Thuật</h3>
          <ul>
            <li><strong>Cân bằng là chìa khóa:</strong> Đừng để bất kỳ chỉ số nào quá thấp hoặc quá cao</li>
            <li><strong>Ưu tiên Kinh Tế:</strong> Nền kinh tế mạnh giúp giải quyết nhiều vấn đề</li>
            <li><strong>Kiểm soát Xung Đột:</strong> Luôn giữ dưới 80, sử dụng đối thoại khi cần</li>
            <li><strong>Đầu tư dài hạn:</strong> Môi Trường và Giáo Dục tạo nền tảng bền vững</li>
            <li><strong>Linh hoạt:</strong> Thích ứng với sự kiện ngẫu nhiên và điều chỉnh chiến lược</li>
          </ul>
        </div>

        <button class="close-guide" onclick="closeGuide()">ĐÓNG</button>
      </div>
    </div>

    <!-- Main Game -->
    <div class="container" id="gameContainer" style="display: none">
      <!-- Header -->
      <div class="header">
        <h1>NGƯỜI CẦM QUYỀN</h1>
        <div class="subtitle">Quyết định tương lai đất nước</div>
      </div>

      <!-- Stats Panel -->
      <div class="stats-panel" id="statsPanel">
        <!-- Stats will be populated by JavaScript -->
      </div>

      <!-- Game Info -->
      <div class="game-info">
        <div class="turn-counter">Lượt <span id="turnCounter">1</span></div>
        <div class="game-score">Điểm <span id="gameScore">0</span></div>
      </div>

      <!-- Story Section -->
      <div class="story-section">
        <div class="story-title" id="storyTitle">Bắt đầu nhiệm kỳ</div>
        <div class="story-text" id="storyText">
          Chào mừng đến với ghế quyền lực. Những quyết định của bạn sẽ định hình tương lai của đất nước.
        </div>
      </div>

      <!-- Choices -->
      <div class="choices-grid" id="choicesGrid">
        <!-- Choices will be populated by JavaScript -->
      </div>

      <!-- Random Event -->
      <div class="random-event" id="randomEvent">
        <!-- Random events will be shown here -->
      </div>

      <!-- Game End -->
      <div class="game-end" id="gameEnd" style="display: none">
        <h2 id="endingTitle">Game Over</h2>
        <div class="ending-description" id="endingDescription"></div>
        <button class="restart-btn" onclick="restartGame()">Chơi lại</button>
      </div>
    </div>

    <script>
      // === DIFFICULTY MODES SYSTEM ===
      
      // Global game state
      let currentDifficulty = 'normal';
      let maxTurns = 30;
      let gameState = {
        currentTurn: 1,
        stats: {
          discontent: 45,
          conflict: 35,
          economy: 55,
          environment: 50,
          freedom: 60,
          security: 45
        },
        score: 0,
        gameEnded: false,
        eventHistory: [],
        usedScenarios: []
      };

      // Difficulty modes configuration - UPDATED ROUNDS
      const DIFFICULTY_MODES = {
        easy: {
          name: "DỄ - Easy Mode",
          description: "Bắt đầu với ít tác động tiêu cực - Perfect for beginners",
          startingStats: {
            discontent: 35,
            conflict: 25,
            economy: 65,
            environment: 60,
            freedom: 70,
            security: 55
          },
          effectMultiplier: 0.7,
          positiveBoost: 1.2,
          randomEventsFrequency: 0.3,
          maxTurns: 15  // UPDATED: 15 rounds
        },
        normal: {
          name: "BÌNH THƯỜNG - Normal Mode", 
          description: "Cân bằng hoàn hảo - Can breathe :D",
          startingStats: {
            discontent: 45,
            conflict: 35,
            economy: 55,
            environment: 50,
            freedom: 60,
            security: 45
          },
          effectMultiplier: 1.0,
          positiveBoost: 1.0,
          randomEventsFrequency: 0.5,
          maxTurns: 30  // UPDATED: 30 rounds
        },
        hard: {
          name: "KHÓ - Hard Mode",
          description: "Thử thách khắc nghiệt nhất - Most hard to play", 
          startingStats: {
            discontent: 55,
            conflict: 45,
            economy: 45,
            environment: 40,
            freedom: 50,
            security: 35
          },
          effectMultiplier: 1.4,
          positiveBoost: 0.8,
          randomEventsFrequency: 0.7,
          maxTurns: 50  // UPDATED: 50 rounds
        }
      };

      // Stat labels
      const statLabels = {
        discontent: "🔥 Bất Mãn",
        conflict: "⚔️ Xung Đột", 
        economy: "💰 Kinh Tế",
        environment: "🌍 Môi Trường",
        freedom: "🗽 Tự Do",
        security: "🛡️ An Ninh"
      };

      // Game data
      let gameStoryData = [];
      let randomEventsData = [];
      let endingsData = [];
      let dictatorModeTriggered = false;

      // Function to show difficulty selection screen
      function showDifficultySelection() {
        document.getElementById('startScreen').classList.add('hidden');
        
        const difficultyHTML = `
        <div class="difficulty-selection" id="difficultySelection">
          <div class="difficulty-modal">
            <h2 style="color: #fff; margin-bottom: 20px; font-size: 2rem;">🎮 CHỌN ĐỘ KHÓ</h2>
            <p style="color: #ccc; margin-bottom: 30px;">SELECT DIFFICULTY MODE</p>
            
            <div class="difficulty-options">
              ${Object.entries(DIFFICULTY_MODES).map(([key, mode]) => `
                <div class="difficulty-option" onclick="selectDifficulty('${key}')">
                  <h3>${mode.name}</h3>
                  <p>${mode.description}</p>
                  <div class="difficulty-stats">
                    Starting Economy: ${mode.startingStats.economy} | 
                    Rounds: ${mode.maxTurns} | 
                    Random Events: ${Math.round(mode.randomEventsFrequency * 100)}%
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>`;
        
        document.body.insertAdjacentHTML('beforeend', difficultyHTML);
      }

      // Function to select difficulty and start game
      function selectDifficulty(difficulty) {
        currentDifficulty = difficulty;
        const mode = DIFFICULTY_MODES[difficulty];
        
        // Set starting stats based on difficulty
        gameState.stats = { ...mode.startingStats };
        maxTurns = mode.maxTurns;
        
        // Remove difficulty selection screen
        document.getElementById('difficultySelection').remove();
        
        // Show difficulty indicator
        showDifficultyIndicator(mode.name);
        
        // Start game
        startGame();
      }

      // Function to show difficulty indicator
      function showDifficultyIndicator(difficultyName) {
        const indicator = `
        <div id="difficulty-indicator">
          🎮 ${difficultyName}
        </div>`;
        
        document.body.insertAdjacentHTML('beforeend', indicator);
      }

      // Function to apply difficulty modifiers to effects
      function applyDifficultyModifiers(effects) {
        const mode = DIFFICULTY_MODES[currentDifficulty];
        const modifiedEffects = {};
        
        Object.entries(effects).forEach(([stat, value]) => {
          if (value > 0) {
            // Positive effect - apply positive boost
            modifiedEffects[stat] = Math.round(value * mode.positiveBoost);
          } else {
            // Negative effect - apply effect multiplier
            modifiedEffects[stat] = Math.round(value * mode.effectMultiplier);
          }
        });
        
        return modifiedEffects;
      }

      // Load game data
      async function loadGameData() {
        try {
          const [storyResponse, eventsResponse, endingsResponse] = await Promise.all([
            fetch('game_story_data_expanded.json'),
            fetch('random_events_enhanced.json'),
            fetch('endings.json')
          ]);
          
          gameStoryData = await storyResponse.json();
          randomEventsData = await eventsResponse.json();
          const endingsJson = await endingsResponse.json();
          endingsData = endingsJson.endings || endingsJson;
          
          console.log('Game data loaded successfully:', {
            scenarios: gameStoryData.length,
            randomEvents: randomEventsData.length,
            endings: endingsData.length
          });
        } catch (error) {
          console.error('Error loading game data:', error);
          // Fallback data
          gameStoryData = [
            {
              id: 1,
              title: "Khủng Hoảng Kinh Tế",
              description: "Nền kinh tế đất nước đang gặp khó khăn nghiêm trọng. GDP giảm mạnh, thất nghiệp tăng cao. Bạn cần có biện pháp khẩn cấp để ổn định tình hình.",
              choices: [
                {
                  title: "Gói kích thích kinh tế 500 tỷ USD",
                  text: "Đầu tư mạnh mẽ vào cơ sở hạ tầng và hỗ trợ doanh nghiệp",
                  effects: { discontent: -10, economy: 25, environment: -5, security: 5 }
                },
                {
                  title: "Cắt giảm chi tiêu chính phủ",
                  text: "Kiểm soát ngân sách chặt chẽ để ổn định tài chính",
                  effects: { discontent: 15, economy: 10, security: -5, freedom: -5 }
                }
              ]
            },
            {
              id: 2,
              title: "Biểu Tình Quy Mô Lớn",
              description: "Hàng ngàn người dân xuống đường biểu tình phản đối chính sách mới. Tình hình có nguy cơ bất ổn.",
              choices: [
                {
                  title: "Đối thoại với người biểu tình",
                  text: "Tổ chức cuộc gặp gỡ để lắng nghe ý kiến",
                  effects: { discontent: -15, conflict: -10, freedom: 10, security: -5 }
                },
                {
                  title: "Tăng cường an ninh",
                  text: "Triển khai lực lượng để duy trì trật tự",
                  effects: { conflict: 15, freedom: -15, security: 10, discontent: 10 }
                }
              ]
            },
            {
              id: 3,
              title: "Thảm Họa Thiên Nhiên",
              description: "Một trận lụt lớn vừa xảy ra, gây thiệt hại nghiêm trọng. Hàng ngàn người dân cần được cứu trợ khẩn cấp.",
              choices: [
                {
                  title: "Huy động tất cả nguồn lực cứu trợ",
                  text: "Triển khai toàn bộ lực lượng để giúp đỡ người dân",
                  effects: { discontent: -20, economy: -15, security: 5, environment: 5 }
                },
                {
                  title: "Kêu gọi cộng đồng quốc tế hỗ trợ",
                  text: "Yêu cầu viện trợ từ các nước bạn và tổ chức quốc tế",
                  effects: { discontent: -10, economy: -5, freedom: 5, environment: 10 }
                }
              ]
            }
          ];
          randomEventsData = [];
          endingsData = [];
        }
      }

      // Initialize game
      function startGame() {
        loadGameData().then(() => {
          document.getElementById('gameContainer').style.display = 'block';
          document.getElementById('guideBtn').style.display = 'block';
          updateDisplay();
          loadCurrentStory();
        });
      }

      // Update stats display
      function updateStatsDisplay() {
        const statsPanel = document.getElementById('statsPanel');
        statsPanel.innerHTML = '';

        Object.entries(gameState.stats).forEach(([stat, value]) => {
          const statElement = document.createElement('div');
          statElement.className = 'stat';
          
          // Color coding based on stat type and value
          let fillColor = '#4caf50'; // Default green
          if (stat === 'discontent' || stat === 'conflict') {
            // Higher is worse for these stats
            fillColor = value >= 70 ? '#ff4444' : value >= 50 ? '#ffaa00' : '#4caf50';
          } else {
            // Higher is better for these stats  
            fillColor = value >= 60 ? '#4caf50' : value >= 40 ? '#ffaa00' : '#ff4444';
          }

          statElement.innerHTML = `
            <div class="stat-label">${statLabels[stat]}</div>
            <div class="stat-value" style="color: ${fillColor}">${value}</div>
            <div class="stat-bar">
              <div class="stat-fill" style="width: ${Math.max(0, Math.min(100, value))}%; background: ${fillColor}"></div>
            </div>
          `;

          statsPanel.appendChild(statElement);
        });
      }

      // Update turn and score
      function updateGameInfo() {
        document.getElementById('turnCounter').textContent = gameState.currentTurn + '/' + maxTurns;
        document.getElementById('gameScore').textContent = gameState.score;
      }

      // FIXED: Load current story function
      function loadCurrentStory() {
        console.log(`Loading story for turn ${gameState.currentTurn}/${maxTurns}`);
        
        // Get available scenarios that haven't been used
        const availableScenarios = gameStoryData.filter(scenario => 
          !gameState.usedScenarios.includes(scenario.id)
        );
        
        let storyData;
        
        if (availableScenarios.length > 0) {
          // Use a random available scenario
          storyData = availableScenarios[Math.floor(Math.random() * availableScenarios.length)];
          gameState.usedScenarios.push(storyData.id);
          console.log(`Selected scenario: ${storyData.title} (ID: ${storyData.id})`);
        } else {
          // All scenarios used, reset and start over
          if (gameStoryData.length > 0) {
            console.log('All scenarios used, resetting used scenarios list');
            gameState.usedScenarios = [];
            storyData = gameStoryData[Math.floor(Math.random() * gameStoryData.length)];
            gameState.usedScenarios.push(storyData.id);
          } else {
            // Fallback scenario
            storyData = {
              id: 999,
              title: "Quyết Định Quan Trọng",
              description: "Một tình huống quan trọng đang chờ quyết định của bạn. Hãy cân nhắc kỹ lưỡng trước khi hành động.",
              choices: [
                {
                  title: "Lựa chọn thận trọng",
                  text: "Hành động một cách cẩn thận và thận trọng để tránh rủi ro",
                  effects: { discontent: -5, security: 5, conflict: -3 }
                },
                {
                  title: "Hành động mạnh mẽ", 
                  text: "Đưa ra quyết định quyết đoán và mạnh mẽ để giải quyết vấn đề",
                  effects: { conflict: -5, freedom: -5, security: 10 }
                }
              ]
            };
          }
        }

        // Display the story
        document.getElementById('storyTitle').textContent = storyData.title;
        document.getElementById('storyText').textContent = storyData.description;
        displayChoices(storyData.choices);
      }

      // Display choices
      function displayChoices(choices) {
        const choicesGrid = document.getElementById('choicesGrid');
        choicesGrid.innerHTML = '';

        // Ensure we have at least 1 choice
        if (!choices || choices.length === 0) {
          choices = [{
            title: "Tiếp tục",
            text: "Chuyển sang lượt tiếp theo",
            effects: { discontent: 0 }
          }];
        }

        choices.forEach((choice, index) => {
          const choiceElement = document.createElement('div');
          choiceElement.className = 'choice';
          choiceElement.onclick = () => makeChoice(choice, index);

          // Create effects preview
          let effectsPreview = '';
          if (choice.effects) {
            Object.entries(choice.effects).forEach(([stat, change]) => {
              if (change !== 0) {
                const sign = change > 0 ? '+' : '';
                const statName = statLabels[stat] || stat;
                effectsPreview += `${statName} ${sign}${change} `;
              }
            });
          }

          choiceElement.innerHTML = `
            <div class="choice-title">${choice.title}</div>
            <div class="choice-text">${choice.text}</div>
            <div class="choice-effects">Tác động: ${effectsPreview || 'Không có'}</div>
          `;

          choicesGrid.appendChild(choiceElement);
        });
      }

      // Make choice
      function makeChoice(choice, index) {
        console.log(`Making choice at turn ${gameState.currentTurn}:`, choice.title);
        
        // Apply difficulty modifiers
        const modifiedEffects = applyDifficultyModifiers(choice.effects || {});
        console.log('Modified effects:', modifiedEffects);
        
        // Apply effects
        Object.entries(modifiedEffects).forEach(([stat, change]) => {
          const oldValue = gameState.stats[stat];
          gameState.stats[stat] = Math.max(0, Math.min(100, gameState.stats[stat] + change));
          console.log(`${stat}: ${oldValue} -> ${gameState.stats[stat]} (${change > 0 ? '+' : ''}${change})`);
        });

        // Update score
        gameState.score += Math.abs(Object.values(modifiedEffects).reduce((sum, val) => sum + val, 0));

        // Update display
        updateDisplay();

        // Check for game end conditions
        if (checkGameEnd()) {
          return;
        }

        // Next turn
        gameState.currentTurn++;

        // Random event chance based on difficulty
        const mode = DIFFICULTY_MODES[currentDifficulty];
        setTimeout(() => {
          if (Math.random() < mode.randomEventsFrequency && randomEventsData.length > 0) {
            triggerRandomEvent();
            setTimeout(() => {
              loadCurrentStory();
            }, 5000);
          } else {
            loadCurrentStory();
          }
        }, 1500);
      }

      // Trigger random event
      function triggerRandomEvent() {
        const event = selectRandomEvent();
        if (event) {
          showRandomEvent(event);
        }
      }

      // Select random event
      function selectRandomEvent() {
        if (!randomEventsData || randomEventsData.length === 0) {
          return null;
        }
        
        return randomEventsData[Math.floor(Math.random() * randomEventsData.length)];
      }

      // Show random event
      function showRandomEvent(event) {
        if (!event) return;

        const randomEventEl = document.getElementById('randomEvent');

        // Apply effects with difficulty modifiers
        const modifiedEffects = applyDifficultyModifiers(event.effects || {});
        let effectsHtml = '';
        
        Object.entries(modifiedEffects).forEach(([stat, change]) => {
          if (change !== 0) {
            // Apply the effect to game state
            const oldValue = gameState.stats[stat];
            gameState.stats[stat] = Math.max(0, Math.min(100, gameState.stats[stat] + change));

            // Create display for the effect
            const label = statLabels[stat] || stat;
            const sign = change > 0 ? '+' : '';
            const className = change > 0 ? 'effect-positive' : change < 0 ? 'effect-negative' : 'effect-neutral';
            effectsHtml += `<div class="effect-item"><span class="${className}">${label} ${sign}${change}</span></div>`;
            
            console.log(`Random event effect - ${stat}: ${oldValue} -> ${gameState.stats[stat]} (${sign}${change})`);
          }
        });

        randomEventEl.innerHTML = `
          <div class="event-title">${event.title}</div>
          <div class="event-description">${event.text}</div>
          <div class="event-effects">
            <div class="effects-title">Ảnh Hưởng</div>
            <div class="effects-grid">${effectsHtml}</div>
          </div>
        `;

        randomEventEl.style.display = 'block';
        
        // Update stats display after applying effects
        updateStatsDisplay();

        // Auto-hide after 5 seconds
        setTimeout(() => {
          randomEventEl.style.display = 'none';
        }, 5000);
      }

      // Check game end conditions
      function checkGameEnd() {
        // Check failure conditions
        if (gameState.stats.conflict >= 85) {
          endGame('revolution', '🔥 CÁCH MẠNG BÙNG NỔ', 'Xung đột đạt mức tới hạn. Người dân nổi dậy và lật đổ chính quyền!');
          return true;
        }

        if (gameState.stats.discontent >= 80) {
          endGame('overthrown', '🔻 MẤT QUYỀN LỰC', 'Sự bất mãn của dân chúng đạt đỉnh điểm. Bạn bị truất phế khỏi chức vụ!');
          return true;
        }

        if (gameState.stats.economy <= 10) {
          endGame('economiccollapse', '📉 SỤP ĐỔ KINH TẾ', 'Nền kinh tế sụp đổ hoàn toàn. Đất nước rơi vào khủng hoảng!');
          return true;
        }

        if (gameState.stats.environment <= 10) {
          endGame('environmental_disaster', '🌍 THẢM HỌA MÔI TRƯỜNG', 'Môi trường bị tàn phá nghiêm trọng. Biến đổi khí hậu và ô nhiễm đã làm đất nước không thể sinh sống!');
          return true;
        }

        // Check success conditions after turn 10
        if (gameState.currentTurn >= 10) {
          // Best Leader Ever ending
          if (gameState.stats.discontent <= 20 && gameState.stats.conflict <= 25 && 
              gameState.stats.economy >= 70 && gameState.stats.environment >= 60 && 
              gameState.stats.freedom >= 65 && gameState.stats.security >= 60) {
            endGame('talented_leader', '🏆 NHÀ LÃNH ĐẠO TÀI BA - BEST LEADER EVER', 'Bạn đã thành công xuất sắc! Đất nước thịnh vượng, dân chúng hạnh phúc, tự do được đảm bảo và an ninh ổn định. You are a best leader ever! Bạn sẽ được nhớ mãi như một nhà lãnh đạo tài ba!');
            return true;
          }

          // Hitler aftermath ending (dictator path)
          if (gameState.stats.security >= 75 && gameState.stats.freedom <= 25) {
            if (!dictatorModeTriggered) {
              dictatorModeTriggered = true;
              // Show temporary dictator message, then collapse after 2 seconds
              setTimeout(() => {
                endGame('hitler_aftermath', '💥 HẬU QUẢ CỦA ĐỘC TÀI - DICTATOR\'S COLLAPSE', 'Bạn đã trở thành nhà độc tài, nhưng lịch sử chứng minh: "Quyền lực tuyệt đối dẫn đến sự sụp đổ tuyệt đối." Một năm sau, cách mạng bùng nổ và lật đổ chế độ độc tài! You look like Hitler after this you will collapse! Giống như trong lịch sử, mọi chế độ độc tài đều có ngày sụp đổ.');
              }, 2000);
              
              endGame('dictator_temporary', '⚔️ ĐỘC TÀI QUÂN SỰ (TẠM THỜI)', 'Bạn đã thiết lập chế độ độc tài quân sự. Đất nước trong tầm kiểm soát tuyệt đối... nhưng lịch sử sẽ phán xét...');
              return true;
            }
          }

          if (gameState.stats.economy >= 85) {
            endGame('economic_emperor', '💰 HOÀNG ĐẾ KINH TẾ', 'Nền kinh tế phát triển mạnh mẽ. Bạn biến đất nước thành cường quốc kinh tế!');
            return true;
          }

          if (gameState.stats.environment >= 85) {
            endGame('environmental_champion', '🌱 VUA BẢO VỆ MÔI TRƯỜNG', 'Bạn đã biến đất nước thành thiên đường xanh. Môi trường được bảo vệ hoàn hảo!');
            return true;
          }
        }

        // Natural end at max turns
        if (gameState.currentTurn > maxTurns) {
          endGame('natural_end', '⏰ KẾT THÚC NHIỆM KỲ', `Bạn hoàn thành nhiệm kỳ cầm quyền ${maxTurns} lượt. Kết quả cuối cùng tùy thuộc vào các chỉ số bạn đạt được.`);
          return true;
        }

        return false;
      }

      // End game
      function endGame(endingType, title, description) {
        console.log(`Game ended with: ${endingType}`);
        gameState.gameEnded = true;
        document.getElementById('endingTitle').textContent = title;
        document.getElementById('endingDescription').textContent = description;
        document.getElementById('gameEnd').style.display = 'block';
        document.getElementById('choicesGrid').style.display = 'none';
      }

      // Restart game
      function restartGame() {
        console.log('Restarting game...');
        
        // Reset game state
        gameState = {
          currentTurn: 1,
          stats: {
            discontent: 45,
            conflict: 35,
            economy: 55,
            environment: 50,
            freedom: 60,
            security: 45
          },
          score: 0,
          gameEnded: false,
          eventHistory: [],
          usedScenarios: []
        };
        
        dictatorModeTriggered = false;

        // Remove difficulty indicator
        const indicator = document.getElementById('difficulty-indicator');
        if (indicator) indicator.remove();

        // Hide end screen
        document.getElementById('gameEnd').style.display = 'none';
        document.getElementById('choicesGrid').style.display = 'grid';
        document.getElementById('guideBtn').style.display = 'none';
        
        // Hide game container and show start screen
        document.getElementById('gameContainer').style.display = 'none';
        document.getElementById('startScreen').classList.remove('hidden');
      }

      // Update all displays
      function updateDisplay() {
        updateStatsDisplay();
        updateGameInfo();
      }

      // Guide functions
      function openGuide() {
        document.getElementById('guideModal').style.display = 'flex';
      }

      function closeGuide() {
        document.getElementById('guideModal').style.display = 'none';
      }

      // Close guide when clicking outside
      document.getElementById('guideModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeGuide();
        }
      });

      // Initialize when page loads
      window.addEventListener('load', function() {
        console.log('Political Simulator loaded with difficulty modes and comprehensive guide');
      });
    </script>
  </body>
</html>
